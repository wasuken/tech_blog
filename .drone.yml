kind: pipeline
type: kubernetes
name: hugo-pipeline

steps:
- name: build-hugo
  image: klakegg/hugo:latest
  commands:
  - cd posts
  - hugo --minify
  - ls -la public/

- name: create-docker-context
  image: alpine:latest
  commands:
  - cp -r posts/public ./public
  - ls -la public/

- name: docker-build
  image: plugins/docker
  settings:
    registry: ghcr.io
    repo: ghcr.io/wasuken/tech_blog
    username:
      from_secret: github_username
    password:
      from_secret: github_token
    tags:
    - latest
    - ${DRONE_COMMIT_SHA:0:8}

- name: deploy-complete
  image: alpine:latest
  commands:
  - echo "Hugo build complete!"
  - echo "Docker image: ghcr.io/wasuken/tech_blog:latest"
  - echo "Image pushed successfully"

# kubectl自動化は一旦コメントアウト♧
# - name: update-deployment
#   image: bitnami/kubectl
#   commands:
#   - kubectl set image deployment/hugo-site hugo=ghcr.io/wasuken/tech_blog:${DRONE_COMMIT_SHA:0:8}
